<!DOCTYPE html>
<html>
<head>
    <title>Site ôn luyện trắc nghiệm</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <style>
        body {
            font-family: 'Times New Roman', Tahoma, Geneva, Verdana, sans-serif; /* Thêm dòng này */
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        h1, h2 {
            color: #333;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #0056b3;
        }

        /* CSS cho đồng hồ đếm ngược (tùy chọn) */
        #countdown {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
            color: red;
        }
        .correct-answer {
            font-weight: bold;
            color: green;
        }
        .incorrect-answer {
            color: red;
        }
        .answer-feedback {
            margin-top: 5px;
            font-style: italic;
        }
        .error-message, .flash-danger  {
            color: red;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .success-message, .flash-success {
            color: green;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .flash-info {
            color: #0c5460;
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .topic-input-group {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .topic-input-group label {
            margin-right: 10px;
        }

        
        .section {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .section-title {
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .footer {
            margin-top: 50px; /* Khoảng cách từ nội dung chính */
            padding: 20px;
            background-color: #f2f2f2; /* Màu nền nhẹ */
            color: #555;
            text-align: center;
            border-top: 1px solid #e7e7e7; /* Đường kẻ phía trên */
            font-size: 0.9em;
        }
        .update-topic-container {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .update-topic-container h2 {
            margin-top: 0;
            color: #333;
        }
        .update-topic-container label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .update-topic-container input[type="text"] {
            width: 80%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .update-topic-container button {
            padding: 10px 15px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
        }
        .update-topic-container button:hover {
            background-color: #218838;
        }
        .update-topic-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            display: none; /* Ẩn ban đầu */
        }
        .success-message {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error-message-topic { /* Đổi tên để tránh trùng với form-error-message */
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .preset-buttons-container {
            margin-top: 20px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .preset-buttons-container h2 {
            margin-top: 0;
            color: #333;
        }
        /* Đảm bảo style cho các nút preset tạo động giống nút hyperlink */
        .preset-button {
            display: inline-block;
            padding: 10px 10px;
            font-size: 1em;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            color: #fff;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            margin-right: 10px;
            margin-bottom: 5px; /* Thêm khoảng cách nếu nhiều nút trên cùng một dòng */
        }
        .preset-button:hover {
            background-color: #0056b3;
        }
        .preset-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }
        .preset-item:last-child {
            border-bottom: none;
        }
        .preset-item button {
            margin-left: 10px;
            padding: 5px 10px;
            font-size: 0.9em;
            background-color: #dc3545; /* Red for delete */
        }
        .preset-item button:hover {
            background-color: #c82333;
        }
        .preset-label {
            flex-grow: 1;
        }

        .topic-management-form {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .message-box {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            display: none; /* Hidden by default */
        }
        .error-message-topic {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .success-message-topic {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        /* CSS cho Collapsible Sections */
        .collapsible-container {
            margin-top: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
            overflow: hidden; /* Để ẩn nội dung khi thu gọn */
        }
        .collapsible-header {
            background-color: #e2e6ea;
            color: #333;
            cursor: pointer;
            padding: 15px;
            width: 100%;
            /*text-align: center;*/
            border: none;
            outline: none;
            font-size: 1.1em;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            /* Thêm thuộc tính position: relative để mũi tên có thể được định vị tuyệt đối bên trong */
            position: relative; /* THÊM DÒNG NÀY */
        }
        .collapsible-header:hover {
            background-color: #d6dbdf;
        }
        .collapsible-header .arrow {
            font-size: 1.2em;
            transition: transform 0.3s ease;
            /* ĐỊNH VỊ MŨI TÊN TUYỆT ĐỐI */
            position: absolute; /* THAY ĐỔI */
            right: 15px; /* Đẩy sang phải với khoảng cách 15px từ mép */
            top: 50%; /* Căn giữa theo chiều dọc */
            transform: translateY(-50%); /* Dịch lên 50% chiều cao của chính nó để căn giữa chính xác */
        }
        .collapsible-header.active .arrow {
            transform: translateY(-50%) rotate(90deg); /* Giữ lại transform Y và xoay */
        }
        .collapsible-content {
            padding: 0 18px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out; /* Hiệu ứng mượt mà khi mở/đóng */
        }
        .collapsible-content.show {
            max-height: 400px; /* Đặt một chiều cao tối đa cụ thể, ví dụ 400px */
            overflow-y: auto; /* Thêm thanh cuộn dọc khi nội dung vượt quá max-height */
            /* Để chiều cao này phù hợp với nội dung của bạn. Nếu nội dung quá ngắn, không có thanh cuộn.
               Nếu quá dài, thanh cuộn sẽ xuất hiện. */
        }

        /* CSS cho nút hyperlink */
        .hyperlink-button {
            display: inline-block;
            padding: 5px 5px;
            font-size: 1em;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            color: #fff;
            background-color: #007bff; /* Màu xanh dương */
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s ease;
            margin-top: 5px; /* Khoảng cách với các phần tử khác */
        }
        .hyperlink-button:hover {
            background-color: #0056b3; /* Màu xanh đậm hơn khi hover */
        }

        /* Thêm một số style nếu bạn muốn nút nằm ở một vị trí cụ thể */
        .admin-button-container {
            text-align: center; /* Để căn giữa nút nếu muốn */
            margin-bottom: 20px;
        }
        /* CSS cho Dropdown Menu */
        .dropdown {
            position: relative;
            display: inline-block;
            margin-bottom: 5px; /* Thêm khoảng cách dưới menu */
        }
        .dropdown-button {
            background-color: #4CAF50; /* Màu xanh lá cây */
            color: white;
            padding: 5px 5px;
            font-size: 1em;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }
        .dropdown-button:hover {
            background-color: #45a049;
        }
        .dropdown-content {
            display: none; /* Ẩn nội dung menu theo mặc định */
            position: absolute;
            background-color: #f9f9f9;
            min-width: 250px; /* Chiều rộng tối thiểu của menu */
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 5px;
            padding: 10px;
        }
        .dropdown-content .menu-item {
            color: black; /* Đặt màu chữ cho các mục menu */
            padding: 5px 10px;
            text-decoration: none;
            display: block;
            border-radius: 3px;
            margin-bottom: 3px; /* Khoảng cách giữa các mục menu */
            background-color: #007bff; /* Giữ màu xanh của hyperlink-button */
            color: #fff; /* Chữ trắng */
            text-align: center; /* Căn trái chữ */
            width: calc(100% - 20px); /* Đảm bảo nút chiếm gần hết chiều rộng */
        }
        .dropdown-content .menu-item:hover {
            background-color: #0056b3; /* Đậm hơn khi hover */
        }
        .dropdown:hover .dropdown-content {
            display: block; /* Hiển thị menu khi hover vào nút dropdown */
        }

        .incorrect-answer {
            font-size: 32px; /* Hoặc giá trị nào đó lớn hơn, ví dụ: 24px, 32px */
            font-weight: bold;
            color: red; /* Hoặc màu sắc khác để nổi bật lỗi */
        }
        .option-item {
            border: 1px solid #ccc; /* Viền mặc định */
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 5px;
            background-color: #f0f0f0; /* Nền nhẹ */
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .option-item:hover {
            background-color: #e0e0e0;
            border-color: #999;
        }
        /* Style cho khi chọn đáp án */
        .option-item.selected {
            background-color: #d1ecf1; /* Nền xanh nhạt khi được chọn */
            border-color: #bee5eb;
        }
        /* Style cho đáp án đúng (có thể dùng sau khi trả lời) */
        .option-item.correct {
            background-color: #d4edda; /* Nền xanh lá cây nhạt */
            border-color: #28a745;
        }
        /* Style cho đáp án sai (có thể dùng sau khi trả lời) */
        .option-item.incorrect {
            background-color: #f8d7da; /* Nền đỏ nhạt */
            border-color: #dc3545;
        }

        .select-all-topics {
            margin-bottom: 10px; /* Khoảng cách dưới cho checkbox "Chọn toàn bộ" */
        }
    </style>
</head>
<body>
    <div style="display: flex; align-items: baseline;">
        <h1 style="margin-bottom: 5px;">Bây giờ là: <span id="realtimeClock"></span>, <span id="currentDate"></span>. </h1>
        <div id="countdown" style="color: burlywood; margin-left: 10px;">Thời gian còn lại: <span id="time"></span> <span id="question-progress"></span></div>
    </div>

    <div class="dropdown">
        <button class="dropdown-button">ADM</button>
        <div class="dropdown-content">
            <button id="view-leaderboard">Xem Bảng Xếp Hạng</button>
            <button id="clear-leaderboard">Xóa Bảng Xếp Hạng</button>
            <a href="http://127.0.0.1:5000/admin" target="_blank" class="hyperlink-button"> Truy cập Trang Admin </a>
        </div>
    </div>

    <a href="http://127.0.0.1:5000/" class="hyperlink-button">http://127.0.0.1:5000/</a>
    <button id="preset-70A-5B-5C-5D" class="hyperlink-button">Doituong2</button>
    <button id="Doituong1" class="hyperlink-button">Doituong1</button>

    <div class="collapsible-container">
        <button type="button" class="collapsible-header" id="quiz-settings-header">
            Khung nội dung chính <span class="arrow">&#9658;</span>
        </button>

        <div class="collapsible-content show" id="quiz-settings-content">
            <form id="quiz-settings">
                <label for="duration">Thời gian làm bài (phút):</label>
                <input type="number" id="duration" name="duration" value="50" min="1">
                <label for="num_questions">Tổng số lượng câu hỏi tối đa cho phép:</label>
                <input type="number" id="num_questions" name="num_questions" value="300" min="1"><br>
                <div style="margin-top: 15px;">
                    <label for="all_topics_question_count">Số câu hỏi cho tất cả chủ đề:</label>
                    <input type="number" id="all_topics_question_count" value="20" min="0">
                    <button type="button" id="apply_to_all_topics">Áp dụng cho tất cả</button>
                </div>

                <div class="collapsible-container">
                    <button type="button" class="collapsible-header" id="topic-selection-header">
                        Chọn Chủ đề chuyên môn nghiệp vụ để ôn luyện <span class="arrow">►</span>
                    </button>
                    <div class="collapsible-content" id="topic-selection-content"> 
                        <div id="topic-inputs-container">
                        </div>
                    </div>
                </div>
                <p>Tổng số câu hỏi đã chọn: <span id="total-topic-questions">0</span>...</p>
                <p id="form-error-message" class="error-message"></p>
                <button type="submit">Bắt đầu bài thi</button>
            </form>
        </div>
    </div>

    <div id="quiz-container" style="display: none;">
        <div id="question"></div>
        <ul id="options"></ul>
        <button id="submit-answer">Tiếp theo</button>
        <button id="submit-final">Nộp bài</button>
        <div id="answer-feedback" class="answer-feedback" style="display: none;"></div>
    </div>


    <div id="result-container" style="display: none;">
        <h2>Kết quả</h2>
        <p id="score"></p>
        <button id="restart-quiz">Làm lại</button>
    </div>

    <div id="leaderboard-container" style="display: none;">
        <h2>Bảng Xếp Hạng</h2>
        <table id="leaderboard">
            <thead>
                <tr>
                    <th>Tên</th>
                    <th>Điểm</th>
                    <th>Thời gian hoàn thành</th>
                </tr>
            </thead>
            <tbody id="leaderboard-body"></tbody>
        </table>
    </div>

    <div class="preset-buttons-container">
        <footer>
            <p>&copy; [Phiên bản: 20250519.0.6 | Liên hệ: <a href="mailto:lequocvan19@gmail.com">vanlequoc</a>] Cùng sự trợ giúp của Google Gemini, Lê Quốc Vân Cooker chập chững biến ý tưởng dựng website local ôn tập trắc nghiệm bằng lập trình Python, pytz, Flask, flask_bcrypt, flask_login, db-sqlite3, pandas, openpyXL; <br> Từ tập tin questions.xlsx với 02 sheets Questions (id câu hỏi đáp án đúng); Options (id câu hỏi các đáp án lựa chọn) tạo ra *.db cho phép lựa chọn số lượng câu hỏi theo từng chủ đề, ngẫu nhiên câu hỏi theo chủ đề và đảo ngẫu nhiên đáp án lựa chọn của từng câu hỏi. Tham khảo: <a href="https://github.com/lequocvan/python_quiz_TracNghiem">Github; </a><a href="https://youtu.be/I8p13W6vsYQ?si=PPCl4vw5AloTTpjj">Youtube</a></p>
        </footer>
    </div>

    <div id="update-topic-container">
        <label for="old_topic_name">Tên Chủ đề CŨ:</label>
        <input type="text" id="old_topic_name" placeholder="Nhập tên chủ đề cũ">
        <label for="new_topic_name">Tên Chủ đề MỚI:</label>
        <input type="text" id="new_topic_name" placeholder="Nhập tên chủ đề mới">
        <button id="update_topic_button">Cập nhật Chủ đề (thận trọng nhé)</button>
        <div id="update-topic-message"></div>
    </div>

    <script>
        const currentDateElement = document.getElementById('currentDate');
        const now = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        currentDateElement.textContent = now.toLocaleDateString('vi-VN', options);

        const realtimeClockElement = document.getElementById('realtimeClock');
        function updateRealtimeClock() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            realtimeClockElement.textContent = `${hours}:${minutes}:${seconds}`;
        }
        // Cập nhật đồng hồ ngay lập tức khi tải trang
        updateRealtimeClock();
        // Cập nhật đồng hồ mỗi giây
        setInterval(updateRealtimeClock, 1000);

        const countdownElement = document.getElementById('countdown');
        const timeDisplay = document.getElementById('time');
        const quizSettingsForm = document.getElementById('quiz-settings');
        const quizContainer = document.getElementById('quiz-container');
        const questionElement = document.getElementById('question');
        const optionsElement = document.getElementById('options');
        const submitAnswerButton = document.getElementById('submit-answer');
        const submitFinalButton = document.getElementById('submit-final'); // Lấy tham chiếu nút Nộp bài
        const answerFeedbackElement = document.getElementById('answer-feedback');
        const resultContainer = document.getElementById('result-container');
        const scoreElement = document.getElementById('score');
        const restartQuizButton = document.getElementById('restart-quiz');
        const durationInput = document.getElementById('duration'); // Lấy input thời gian

        const topicInputsContainer = document.getElementById('topic-inputs-container');
        const totalTopicQuestionsElement = document.getElementById('total-topic-questions');
        const numQuestionsInput = document.getElementById('num_questions');
        const formErrorMessage = document.getElementById('form-error-message');

        const leaderboardContainer = document.getElementById('leaderboard-container');
        const leaderboardTableBody = document.getElementById('leaderboard-body');
        const viewLeaderboardButton = document.getElementById('view-leaderboard');
        const clearLeaderboardButton = document.getElementById('clear-leaderboard'); // Lấy tham chiếu nút xóa
        let leaderboardData = loadLeaderboard(); // Tải dữ liệu bảng xếp hạng khi trang tải
        // Đảm bảo nút "Xem Bảng Xếp Hạng" luôn hiển thị
        if (viewLeaderboardButton) {
            viewLeaderboardButton.style.display = 'inline-block'; // Hoặc 'block'
        }

        let currentQuestionIndex = 0;
        let allQuestionsData = []; // Lưu trữ toàn bộ dữ liệu câu hỏi
        let questionsData = []; // Lưu trữ các câu hỏi sẽ hiển thị (có thể là ngẫu nhiên)
        let selectedAnswers = [];
        let timerInterval;
        let timeLeft;
        let correctAnswersCount = 0; // Biến đếm số câu trả lời đúng
        let hasAnswered = false; // Theo dõi xem người dùng đã trả lời câu hỏi hiện tại chưa
        let questionTimeout; // Biến để lưu ID của setTimeout cho mỗi câu hỏi

        let questionStartTime; // Thêm biến để lưu thời gian bắt đầu một câu hỏi
        let questionDetailsList = []; // Thêm mảng để lưu chi tiết từng câu hỏi

        const questionProgressElement = document.getElementById('question-progress');

        // JavaScript cho Collapsible Sections
        const quizSettingsHeader = document.getElementById('quiz-settings-header');
        const quizSettingsContent = document.getElementById('quiz-settings-content');

        quizSettingsHeader.addEventListener('click', () => {
            quizSettingsHeader.classList.toggle('active');
            if (quizSettingsContent.classList.contains('show')) {
                quizSettingsContent.classList.remove('show');
                quizSettingsContent.style.maxHeight = null;
            } else {
                quizSettingsContent.classList.add('show');
                quizSettingsContent.style.maxHeight = quizSettingsContent.scrollHeight + "px";
            }
        });


        // New elements for applying to all topics
        const allTopicsQuestionCountInput = document.getElementById('all_topics_question_count');
        const applyToAllTopicsButton = document.getElementById('apply_to_all_topics');

        if (applyToAllTopicsButton) {
            applyToAllTopicsButton.addEventListener('click', () => {
                const count = parseInt(allTopicsQuestionCountInput.value, 10);
                if (isNaN(count) || count < 0) {
                    alert("Vui lòng nhập một số hợp lệ cho số câu hỏi.");
                    return;
                }

                const topicInputs = document.querySelectorAll('#topic-inputs-container input[type="number"]');
                const topicCheckboxes = document.querySelectorAll('#topic-inputs-container input[type="checkbox"]');

                topicInputs.forEach((input, index) => {
                    const checkbox = topicCheckboxes[index];
                    if (checkbox.checked) {
                        input.value = count;
                    }
                });
                updateTopicQuestionCount();
                enforceTotalLimit();
            });
        }

        // Thêm xử lý cho phần collapsible Chủ đề mới
        const topicSelectionHeader = document.getElementById('topic-selection-header');
        const topicSelectionContent = document.getElementById('topic-selection-content');

        topicSelectionHeader.addEventListener('click', () => {
            topicSelectionHeader.classList.toggle('active');
            if (topicSelectionContent.classList.contains('show')) {
                topicSelectionContent.classList.remove('show');
                topicSelectionContent.style.maxHeight = null;
            } else {
                topicSelectionContent.classList.add('show');
                topicSelectionContent.style.maxHeight = topicSelectionContent.scrollHeight + "px";
            }
        });

        // Đảm bảo collapsible chính được mở khi tải trang hoặc thiết lập lại nếu cần
        // Nếu bạn muốn mặc định phần "Chọn Chủ đề" mở khi tải trang, thêm class 'show' vào div
        // topic-selection-content và đoạn mã sau.
        // Ngược lại, nếu muốn mặc định đóng, bỏ qua đoạn mã dưới.
        if (quizSettingsContent.classList.contains('show')) {
             quizSettingsContent.style.maxHeight = quizSettingsContent.scrollHeight + "px";
        }
        // Nếu bạn muốn phần chọn chủ đề mở mặc định
        if (topicSelectionContent.classList.contains('show')) {
             topicSelectionContent.style.maxHeight = topicSelectionContent.scrollHeight + "px";
             topicSelectionHeader.classList.add('active'); // Đảm bảo mũi tên xoay đúng hướng
        }


        // Hàm xáo trộn mảng (Thuật toán Fisher-Yates)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function updateTopicQuestionCount() {
            let total = 0;
            const topicInputs = document.querySelectorAll('#topic-inputs-container input[type="number"]');
            topicInputs.forEach(input => {
                total += parseInt(input.value) || 0;
            });
            totalTopicQuestionsElement.textContent = total;
            return total;
        }


        
        // Lấy danh sách chủ đề topic khi trang tải
        fetch('/get_topics')
            .then(response => response.json())
            .then(topics => {
                topics.forEach(topic => {
                    const topicInputGroup = document.createElement('div');
                    topicInputGroup.className = 'topic-input-group';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = topic;
                    checkbox.name = topic;

                    const label = document.createElement('label');
                    label.textContent = topic;
                    label.setAttribute('for', topic);


                    const input = document.createElement('input');
                    input.type = 'number';
                    input.value = 0;
                    input.min = 0;
                    input.max = 100;
                    input.disabled = true; // Disable initially

                    checkbox.addEventListener('change', () => {
                        input.disabled = !checkbox.checked;
                        if (!checkbox.checked) {
                            input.value = 0; // Reset value when unchecked
                        }
                        updateTopicQuestionCount();
                        enforceTotalLimit();
                    });

                    input.addEventListener('change', () => {
                        updateTopicQuestionCount();
                        enforceTotalLimit();
                    });

                    topicInputGroup.appendChild(checkbox);
                    topicInputGroup.appendChild(label);
                    topicInputGroup.appendChild(input);
                    topicInputsContainer.appendChild(topicInputGroup);
                });
                updateTopicQuestionCount();
            });

        function enforceTotalLimit() {
            const numQuestions = parseInt(numQuestionsInput.value, 10);
            const topicInputs = document.querySelectorAll('#topic-inputs-container input[type="number"]');
            let currentTotal = updateTopicQuestionCount();

            topicInputs.forEach(input => {
                if (!input.disabled) {
                    let selectedValue = parseInt(input.value, 10) || 0;
                    // The max value for an individual topic input should be the total allowed
                    // minus the sum of other selected topics.
                    // This logic might be complex if you want to strictly prevent exceeding the total.
                    // A simpler approach is to check the total on submit and show an error.
                    // For now, let's just make sure individual inputs don't exceed the overall num_questions.
                    input.max = numQuestions; // Can set a higher max here, and validate on submit
                } else {
                    input.max = numQuestions;
                }
            });
        }

        // Hàm mới để lấy và hiển thị tất cả các preset_name
        function loadAndDisplayPresets() {
            const dynamicPresetButtonsContainer = document.getElementById('dynamic-preset-buttons');
            dynamicPresetButtonsContainer.innerHTML = ''; // Xóa các nút cũ nếu có

            fetch('/get_all_preset_names')
                .then(response => response.json())
                .then(presetNames => {
                    if (presetNames.length === 0) {
                        dynamicPresetButtonsContainer.textContent = "Không tìm thấy cấu hình preset nào.";
                        return;
                    }

                    presetNames.forEach(presetName => {
                        const button = document.createElement('button');
                        button.textContent = presetName;
                        button.className = 'preset-button'; // Sử dụng class CSS mới
                        button.addEventListener('click', () => {
                            // Gọi endpoint phù hợp dựa trên presetName
                            let configEndpoint = '';
                            if (presetName === 'Doituong1') {
                                configEndpoint = '/get_Doituong1_config';
                            } else if (presetName === 'Doituong2') {
                                configEndpoint = '/get_preset_70a_5b_5c_5d_config';
                            }
                            // Thêm các trường hợp khác cho các preset_name khác nếu cần
                            // else if (presetName === 'Ten_Preset_Khac') {
                            //     configEndpoint = '/get_Ten_Preset_Khac_config';
                            // }
                            
                            if (configEndpoint) {
                                fetch(configEndpoint)
                                    .then(response => {
                                        if (!response.ok) {
                                            throw new Error('Network response was not ok ' + response.statusText);
                                        }
                                        return response.json();
                                    })
                                    .then(presetCounts => {
                                        setPresetTopicCounts(presetCounts);
                                        formErrorMessage.textContent = `Đã tải cấu hình cho preset: ${presetName}`;
                                        formErrorMessage.className = 'success-message';
                                        formErrorMessage.style.display = 'block';
                                    })
                                    .catch(error => {
                                        console.error(`Lỗi khi lấy cấu hình preset "${presetName}":`, error);
                                        formErrorMessage.textContent = `Không thể tải cấu hình cho preset "${presetName}". Vui lòng thử lại.`;
                                        formErrorMessage.className = 'error-message';
                                        formErrorMessage.style.display = 'block';
                                    });
                            } else {
                                formErrorMessage.textContent = `Chưa có cấu hình endpoint cho preset: ${presetName}.`;
                                formErrorMessage.className = 'error-message';
                                formErrorMessage.style.display = 'block';
                            }
                        });
                        dynamicPresetButtonsContainer.appendChild(button);
                    });
                })
                .catch(error => {
                    console.error("Lỗi khi tải danh sách preset:", error);
                    dynamicPresetButtonsContainer.textContent = "Không thể tải danh sách preset. Vui lòng kiểm tra kết nối.";
                });
        }
        
        // Xử lý preset 70A-5B-5C-5D Doituong2
        document.getElementById('preset-70A-5B-5C-5D').addEventListener('click', () => {
            fetch('/get_preset_70a_5b_5c_5d_config')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    return response.json();
                })
                .then(presetCounts => {
                    setPresetTopicCounts(presetCounts);
                })
                .catch(error => {
                    console.error("Lỗi khi lấy cấu hình preset:", error);
                    formErrorMessage.textContent = "Không thể tải cấu hình preset. Vui lòng thử lại.";
                });
        });

        // Xử lý preset Doituong1
        document.getElementById('Doituong1').addEventListener('click', () => {
            fetch('/get_Doituong1_config')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    return response.json();
                })
                .then(presetCounts => {
                    setPresetTopicCounts(presetCounts);
                })
                .catch(error => {
                    console.error("Lỗi khi lấy cấu hình preset:", error);
                    formErrorMessage.textContent = "Không thể tải cấu hình preset. Vui lòng thử lại.";
                });
        });


        function setPresetTopicCounts(presetCounts) {
            const topicInputs = document.querySelectorAll('#topic-inputs-container input[type="number"]');
            const topicCheckboxes = document.querySelectorAll('#topic-inputs-container input[type="checkbox"]');

            // Đặt tất cả về 0 và bỏ chọn
            topicInputs.forEach(input => {
                input.value = 0;
                input.disabled = true;
            });
            topicCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });

            // Áp dụng các giá trị preset
            for (const topicName in presetCounts) {
                const checkbox = document.getElementById(topicName);
                if (checkbox) {
                    checkbox.checked = true;
                    // Find the input element associated with this checkbox
                    const input = checkbox.parentNode.querySelector('input[type="number"]');
                    if (input) {
                        input.value = presetCounts[topicName];
                        input.disabled = false;
                    }
                }
            }
            updateTopicQuestionCount(); // Cập nhật tổng số câu hỏi đã chọn
            enforceTotalLimit(); // Đảm bảo giới hạn tổng số câu hỏi
        }


        
        quizSettingsForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const numQuestions = parseInt(document.getElementById('num_questions').value);
            const durationMinutes = parseInt(durationInput.value);
            const totalTopicQuestions = updateTopicQuestionCount();

            formErrorMessage.textContent = '';

            // The backend will handle fetching questions to meet numQuestions,
            // so we don't need to block if totalTopicQuestions < numQuestions here.
            // But if totalTopicQuestions > numQuestions, it's an error.
            if (totalTopicQuestions > numQuestions) {
                formErrorMessage.textContent = `Tổng số câu hỏi theo chủ đề (${totalTopicQuestions}) vượt quá Tổng số lượng câu hỏi tối đa cho phép (${numQuestions}).`;
                return;
            }

            timeLeft = durationMinutes * 60;
            correctAnswersCount = 0;
            currentQuestionIndex = 0;
            selectedAnswers = new Array(numQuestions).fill(null);
            questionDetailsList = []; // Reset question details list
            hasAnswered = false;

            const topicCounts = {};
            const topicInputs = document.querySelectorAll('#topic-inputs-container input[type="number"]');
            const topicCheckboxes = document.querySelectorAll('#topic-inputs-container input[type="checkbox"]');

            topicInputs.forEach((input, index) => {
                // Ensure the checkbox is checked AND the input value is greater than 0
                if (topicCheckboxes[index].checked && parseInt(input.value) > 0) {
                    const topicName = topicCheckboxes[index].id;
                    topicCounts[topicName] = parseInt(input.value);
                }
            });
            
            fetch('/start_quiz', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    num_questions: numQuestions,
                    duration: durationMinutes,
                    topics: topicCounts
                })
            })
            .then(response => {
                if (!response.ok) {
                    // Check if the response is JSON before parsing
                    return response.json().then(errorData => {
                        throw new Error(errorData.error || 'Unknown error from server');
                    });
                }
                return response.json();
            })
            .then(data => {
                // Check if the data is an error object
                if (data.error) {
                    formErrorMessage.textContent = `Error: ${data.error}`;
                    return;
                }
                allQuestionsData = data;
                const shuffledQuestions = shuffleArray([...allQuestionsData]);
                questionsData = shuffledQuestions.slice(0, numQuestions); // Ensure we only take 'numQuestions'

                if (questionsData.length === 0) {
                    formErrorMessage.textContent = "Không có câu hỏi nào được tìm thấy với các chủ đề đã chọn. Vui lòng chọn lại.";
                    return;
                }

                quizSettingsForm.style.display = 'none';
                quizContainer.style.display = 'block';
                startTimer();
                showQuestion();
            })
            .catch(error => {
                console.error("Lỗi khi gửi dữ liệu:", error);
                formErrorMessage.textContent = "Có lỗi xảy ra khi bắt đầu bài thi: " + error.message;
            });
        });

        function startTimer() {
            clearInterval(timerInterval); // Xóa interval cũ nếu có
            timerInterval = setInterval(updateTimer, 1000);
        }

        function updateTimer() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = (timeLeft % 60).toString().padStart(2, '0');
            timeDisplay.textContent = `${minutes}:${seconds}`;
            timeLeft--;

            if (timeLeft < 0) {
                clearInterval(timerInterval);
                alert("Hết thời gian làm bài!");
                submitQuiz(); // Tự động nộp bài khi hết thời gian
            }
        }

        function showQuestion() {
            answerFeedbackElement.style.display = 'none'; // Ẩn phản hồi đáp án khi hiển thị câu hỏi mới
            hasAnswered = false; // Reset trạng thái đã trả lời cho câu hỏi mới
            clearTimeout(questionTimeout); // Hủy bỏ timeout của câu hỏi trước nếu có

            if (currentQuestionIndex < questionsData.length) {
                const currentQuestion = questionsData[currentQuestionIndex];
                questionElement.textContent = `${currentQuestionIndex + 1}. ${currentQuestion.question_text}`;
                optionsElement.innerHTML = '';

                questionProgressElement.textContent = `(${currentQuestionIndex + 1}/${questionsData.length})`;
                questionStartTime = Date.now(); // Ghi lại thời gian bắt đầu câu hỏi

                // Tách chuỗi options thành mảng
                const options = currentQuestion.options ? currentQuestion.options.split('|||') : [];
                const shuffledOptions = shuffleArray(options);

                shuffledOptions.forEach((option, index) => {
                    const li = document.createElement('li');
                    li.className = 'option-item'; // Thêm lớp CSS mới vào li
                    li.innerHTML = `
                        <input type="radio" name="answer" value="${option}" id="option-${index}">
                        <label for="option-${index}">${option}</label>
                    `;
                    const input = li.querySelector('input');

                    input.addEventListener('change', () => {
                        // Xóa lớp 'selected' khỏi tất cả các mục khác
                        document.querySelectorAll('.option-item').forEach(item => {
                            item.classList.remove('selected');
                        });
                        // Thêm lớp 'selected' vào mục hiện tại khi được chọn
                        li.classList.add('selected');

                        selectedAnswers[currentQuestionIndex] = option;
                        hasAnswered = true; // Mark as answered when an option is selected
                        clearTimeout(questionTimeout); // Stop timeout if user answers manually
                    });

                    optionsElement.appendChild(li);

                    if (selectedAnswers[currentQuestionIndex] === option) {
                        input.checked = true;
                        li.classList.add('selected'); // Đảm bảo mục được chọn có lớp 'selected' khi tải lại
                    }
                });

                // Display "Nộp bài" button always, "Tiếp theo" only if not last question
                submitFinalButton.style.display = 'inline-block';
                if (currentQuestionIndex === questionsData.length - 1) {
                    submitAnswerButton.style.display = 'none'; // Hide "Tiếp theo" on the last question
                } else {
                    submitAnswerButton.style.display = 'inline-block';
                }

                // Hẹn giờ tự động hiển thị đáp án và chuyển câu sau 30 giây
                questionTimeout = setTimeout(() => {
                    showCorrectAnswerAndNext();
                }, 30000); // 30000 milliseconds = 30 giây

            } else {
                // If there are no more questions to show, submit the quiz
                clearInterval(timerInterval);
                submitQuiz();
            }
        }

        submitAnswerButton.addEventListener('click', () => {
            clearTimeout(questionTimeout); // Hủy bỏ timeout khi người dùng bấm "Tiếp theo"
            const selectedOption = document.querySelector('input[name="answer"]:checked');

            const currentQuestion = questionsData[currentQuestionIndex];
            const timeSpent = Math.round((Date.now() - questionStartTime) / 1000); // Thời gian làm câu hỏi

            let userAnswer = null;
            let isCorrect = 0; // 0 for false, 1 for true

            if (selectedOption) {
                userAnswer = selectedOption.value;
                if (userAnswer === currentQuestion.correct_answer) {
                    isCorrect = 1;
                }
                showAnswerFeedback(userAnswer);
            } else {
                // User didn't select an answer, treat as unanswered
                showAnswerFeedback(null); // Pass null to indicate no selection
            }

            questionDetailsList.push({
                question_id: currentQuestion.id,
                question_text: currentQuestion.question_text,
                user_answer: userAnswer,
                correct_answer: currentQuestion.correct_answer,
                is_correct: isCorrect,
                time_spent_on_question: timeSpent
            });

            setTimeout(() => {
                currentQuestionIndex++;
                showQuestion();
            }, 5000); // Wait 5 seconds before moving to the next question
        });

        // Hàm hiển thị phản hồi đáp án
        function showAnswerFeedback(selectedValue) {
            const currentQuestion = questionsData[currentQuestionIndex];
            const correctAnswer = currentQuestion.correct_answer;

            answerFeedbackElement.style.display = 'block';

            // Gỡ bỏ các lớp màu cũ và thêm lớp màu mới cho tất cả các tùy chọn
            document.querySelectorAll('.option-item').forEach(item => {
                item.classList.remove('correct', 'incorrect', 'selected'); // Xóa các lớp màu cũ và lớp selected
            });

            // Highlight đáp án đúng
            document.querySelectorAll('#options input[name="answer"]').forEach(input => {
                const li = input.closest('li');
                if (input.value === correctAnswer) {
                    li.classList.add('correct');
                } else if (selectedValue !== null && input.value === selectedValue) { // Nếu là đáp án người dùng chọn và là sai
                    li.classList.add('incorrect');
                }
            });

            if (selectedValue === correctAnswer) {
                answerFeedbackElement.textContent = "Chính xác! 🎉 Chúc mừng!"; 
                answerFeedbackElement.className = "answer-feedback correct-answer";
                // correctAnswersCount is incremented when saving to questionDetailsList for consistency
            } else if (selectedValue === null) {
                answerFeedbackElement.textContent = `Hết thời gian. Đáp án đúng là: ${correctAnswer}`;
                answerFeedbackElement.className = "answer-feedback incorrect-answer"; // Use incorrect-answer for timeout too
            } else {
                answerFeedbackElement.textContent = `SAI. Đáp án đúng là: ${correctAnswer}`;
                answerFeedbackElement.className = "answer-feedback incorrect-answer";
            }
        }

        function showCorrectAnswerAndNext() {
            const currentQuestion = questionsData[currentQuestionIndex];
            const correctAnswer = currentQuestion.correct_answer;

            const timeSpent = Math.round((Date.now() - questionStartTime) / 1000); // Thời gian làm câu hỏi

            // Record that user didn't answer (user_answer will be null)
            questionDetailsList.push({
                question_id: currentQuestion.id,
                question_text: currentQuestion.question_text,
                user_answer: null, // No answer selected
                correct_answer: correctAnswer,
                is_correct: 0, // Not correct
                time_spent_on_question: timeSpent
            });

            answerFeedbackElement.textContent = `Đã hết thời gian. Đáp án đúng là: ${correctAnswer}`;
            answerFeedbackElement.className = "answer-feedback auto-next";
            answerFeedbackElement.style.display = 'block';

            // Gỡ bỏ các lớp màu cũ và thêm lớp màu mới cho tất cả các tùy chọn
            document.querySelectorAll('.option-item').forEach(item => {
                item.classList.remove('correct', 'incorrect', 'selected'); // Xóa các lớp màu cũ
            });

            // Highlight đáp án đúng khi tự động chuyển
            document.querySelectorAll('#options input[name="answer"]').forEach(input => {
                const li = input.closest('li');
                if (input.value === correctAnswer) {
                    li.classList.add('correct');
                }
            });

            // Add text-to-speech for correct answer
            if ('speechSynthesis' in window) {
                const speech = new SpeechSynthesisUtterance();
                speech.lang = 'vi-VN';
                speech.text = `Đáp án đúng là: ${correctAnswer}`;
                window.speechSynthesis.speak(speech);
            }

            setTimeout(() => {
                currentQuestionIndex++;
                showQuestion();
            }, 10000); // Chuyển sang câu tiếp theo sau 10 giây
        }

        // Xử lý sự kiện click nút "Nộp bài"
        submitFinalButton.addEventListener('click', () => {
            clearTimeout(questionTimeout); // Dừng bộ hẹn giờ 36 giây đếm cho câu hỏi hiện tại (nếu nó đang chạy)
            clearInterval(timerInterval); // Dừng bộ đếm thời gian Tổng của bài thi
            
            // Record current question's state if it hasn't been recorded yet
            if (currentQuestionIndex < questionsData.length) {
                const currentQuestion = questionsData[currentQuestionIndex];
                const selectedOption = document.querySelector('input[name="answer"]:checked');
                const timeSpent = Math.round((Date.now() - questionStartTime) / 1000);

                let userAnswer = null;
                let isCorrect = 0;
                if (selectedOption) {
                    userAnswer = selectedOption.value;
                    if (userAnswer === currentQuestion.correct_answer) {
                        isCorrect = 1;
                    }
                }
                
                questionDetailsList.push({
                    question_id: currentQuestion.id,
                    question_text: currentQuestion.question_text,
                    user_answer: userAnswer,
                    correct_answer: currentQuestion.correct_answer,
                    is_correct: isCorrect,
                    time_spent_on_question: timeSpent
                });
            }

            submitQuiz();
        });


        function saveScore(score, totalQuestions, percentage, timeTaken) {
            const playerName = prompt("Nhập tên của bạn để lưu điểm:");
            if (playerName) {
                fetch('/save_quiz_result', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        player_name: playerName,
                        score: score,
                        total_questions: totalQuestions,
                        percentage: percentage,
                        time_taken: timeTaken,
                        question_details: questionDetailsList // Gửi chi tiết câu hỏi
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert("Lỗi khi lưu điểm: " + data.error);
                    } else {
                        alert("Điểm của bạn đã được lưu thành công!");
                        // Optionally update local leaderboard data as well if it's still being used for display
                        // This part might need adjustment if you rely solely on the database for leaderboard
                        leaderboardData.push({ name: playerName, score: score, time: timeTaken });
                        leaderboardData.sort((a, b) => b.score - a.score);
                        saveLeaderboard(); // Save to localStorage for local leaderboard display
                    }
                })
                .catch(error => {
                    console.error("Lỗi khi gửi dữ liệu lưu điểm:", error);
                    alert("Có lỗi xảy ra khi lưu điểm.");
                });
            }
        }

        function saveLeaderboard() {
            localStorage.setItem('quizLeaderboard', JSON.stringify(leaderboardData));
        }

        function loadLeaderboard() {
            const storedLeaderboard = localStorage.getItem('quizLeaderboard');
            return storedLeaderboard ? JSON.parse(storedLeaderboard) : [];
        }

        function displayLeaderboard() {
            console.log('Dữ liệu bảng xếp hạng:', leaderboardData);
            leaderboardTableBody.innerHTML = ''; // Xóa dữ liệu cũ
            leaderboardData.forEach(entry => {
                const row = leaderboardTableBody.insertRow();
                const nameCell = row.insertCell();
                const scoreCell = row.insertCell();
                const timeCell = row.insertCell();
                nameCell.textContent = entry.name;
                scoreCell.textContent = entry.score;
                const minutes = Math.floor(entry.time / 60);
                const seconds = (entry.time % 60).toString().padStart(2, '0');
                timeCell.textContent = `${minutes}:${seconds}`;
            });
            quizSettingsForm.style.display = 'none';
            quizContainer.style.display = 'none';
            resultContainer.style.display = 'none';
            leaderboardContainer.style.display = 'block';
        }

        function clearLeaderboard() {
            if (confirm("Bạn có chắc chắn muốn xóa toàn bộ bảng xếp hạng?")) {
                localStorage.removeItem('quizLeaderboard');
                leaderboardData = [];
                displayLeaderboard(); // Cập nhật lại hiển thị bảng xếp hạng
            }
        }


        function submitQuiz() {
            clearInterval(timerInterval); // Dừng đồng hồ khi nộp bài
            clearTimeout(questionTimeout); // Đảm bảo hủy timeout khi nộp bài
            
            // Calculate final score based on questionDetailsList
            correctAnswersCount = questionDetailsList.filter(detail => detail.is_correct === 1).length;

            questionProgressElement.textContent = ''; // Hoặc có thể ẩn nó

            quizContainer.style.display = 'none';
            resultContainer.style.display = 'block';
            // Tính toán tỷ lệ phần trăm
            const percentage = (correctAnswersCount / questionsData.length) * 100;

            scoreElement.textContent = `Bạn đã trả lời đúng ${correctAnswersCount} trên ${questionsData.length} câu hỏi (${percentage.toFixed(2)}%).`;
            
            // Save score after displaying results
            // The time taken is (initial duration in seconds) - (timeLeft at submission)
            const timeTaken = (parseInt(durationInput.value) * 60) - timeLeft;
            saveScore(correctAnswersCount, questionsData.length, percentage, timeTaken);
        }


        restartQuizButton.addEventListener('click', () => {
            resultContainer.style.display = 'none';
            quizSettingsForm.style.display = 'block';
            clearInterval(timerInterval); // Dừng đồng hồ khi làm lại
            clearTimeout(questionTimeout); // Hủy bỏ timeout khi làm lại
            timeDisplay.textContent = ''; // Xóa thời gian hiển thị
            currentQuestionIndex = 0;
            selectedAnswers = [];
            questionsData = [];
            questionDetailsList = []; // Reset question details list
            correctAnswersCount = 0; // Reset điểm số khi làm lại
            submitAnswerButton.style.display = 'inline-block'; // Hiển thị lại nút "Tiếp theo"
            submitFinalButton.style.display = 'none'; // Ẩn nút "Nộp bài"
            hasAnswered = false;
            formErrorMessage.textContent = ''; // Clear any previous error messages
        });


        // Thêm sự kiện lắng nghe cho nút xem bảng xếp hạng
        viewLeaderboardButton.addEventListener('click', displayLeaderboard);

        // Thêm sự kiện lắng nghe cho nút xóa bảng xếp hạng
        clearLeaderboardButton.addEventListener('click', clearLeaderboard);

        // Ẩn nút "Nộp bài" ban đầu
        submitFinalButton.style.display = 'none';
        
        // Initial call to update total question count and enforce limits
        updateTopicQuestionCount();
        enforceTotalLimit();



        // Thêm JavaScript cho chức năng cập nhật topic
        const updateTopicButton = document.getElementById('update_topic_button');
        const oldTopicNameInput = document.getElementById('old_topic_name');
        const newTopicNameInput = document.getElementById('new_topic_name');
        const updateTopicMessage = document.getElementById('update-topic-message');

        updateTopicButton.addEventListener('click', () => {
            const oldTopic = oldTopicNameInput.value.trim();
            const newTopic = newTopicNameInput.value.trim();

            updateTopicMessage.style.display = 'none'; // Ẩn thông báo cũ
            updateTopicMessage.className = ''; // Xóa lớp CSS cũ

            if (!oldTopic || !newTopic) {
                updateTopicMessage.textContent = "Vui lòng nhập đầy đủ tên chủ đề cũ và mới.";
                updateTopicMessage.className = 'error-message-topic';
                updateTopicMessage.style.display = 'block';
                return;
            }

            fetch('/update_topic', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    old_topic: oldTopic,
                    new_topic: newTopic
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    updateTopicMessage.textContent = `Lỗi: ${data.error}`;
                    updateTopicMessage.className = 'error-message-topic';
                } else {
                    updateTopicMessage.textContent = `Topic đã được cập nhật thành công! (Questions: ${data.questions_updated}, Presets: ${data.presets_updated})`;
                    updateTopicMessage.className = 'success-message';
                    // Xóa giá trị trong input sau khi thành công
                    oldTopicNameInput.value = '';
                    newTopicNameInput.value = '';

                    // Cập nhật lại danh sách chủ đề nếu bạn muốn hiển thị nó trong form quiz ngay lập tức
                    // Điều này yêu cầu gọi lại hàm fetch('/get_topics') và xây dựng lại các checkbox/input
                    // Hoặc đơn giản hơn là nhắc người dùng làm mới trang.
                    alert("Topic đã được cập nhật thành công. Vui lòng làm mới trang để xem các thay đổi trong danh sách chủ đề.");
                }
                updateTopicMessage.style.display = 'block';
            })
            .catch(error => {
                console.error("Lỗi khi cập nhật topic:", error);
                updateTopicMessage.textContent = "Có lỗi xảy ra khi gửi yêu cầu cập nhật topic.";
                updateTopicMessage.className = 'error-message-topic';
                updateTopicMessage.style.display = 'block';
            });
        });
    </script>
</body>
</html>