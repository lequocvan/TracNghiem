<!DOCTYPE html>
<html>
<head>
    <title>Site √¥n luy·ªán tr·∫Øc nghi·ªám</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <style>
        body {
            font-family: 'Times New Roman', Tahoma, Geneva, Verdana, sans-serif; /* Th√™m d√≤ng n√†y */
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        h1, h2 {
            color: #333;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #0056b3;
        }

        /* CSS cho ƒë·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c (t√πy ch·ªçn) */
        #countdown {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
            color: red;
        }
        .correct-answer {
            font-weight: bold;
            color: green;
        }
        .incorrect-answer {
            color: red;
        }
        .answer-feedback {
            margin-top: 5px;
            font-style: italic;
        }
        .error-message, .flash-danger  {
            color: red;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .success-message, .flash-success {
            color: green;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .flash-info {
            color: #0c5460;
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .topic-input-group {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .topic-input-group label {
            margin-right: 10px;
        }

        
        .section {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .section-title {
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .footer {
            margin-top: 50px; /* Kho·∫£ng c√°ch t·ª´ n·ªôi dung ch√≠nh */
            padding: 20px;
            background-color: #f2f2f2; /* M√†u n·ªÅn nh·∫π */
            color: #555;
            text-align: center;
            border-top: 1px solid #e7e7e7; /* ƒê∆∞·ªùng k·∫ª ph√≠a tr√™n */
            font-size: 0.9em;
        }
        .update-topic-container {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .update-topic-container h2 {
            margin-top: 0;
            color: #333;
        }
        .update-topic-container label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .update-topic-container input[type="text"] {
            width: 80%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .update-topic-container button {
            padding: 10px 15px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
        }
        .update-topic-container button:hover {
            background-color: #218838;
        }
        .update-topic-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            display: none; /* ·∫®n ban ƒë·∫ßu */
        }
        .success-message {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error-message-topic { /* ƒê·ªïi t√™n ƒë·ªÉ tr√°nh tr√πng v·ªõi form-error-message */
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .preset-buttons-container {
            margin-top: 20px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .preset-buttons-container h2 {
            margin-top: 0;
            color: #333;
        }
        /* ƒê·∫£m b·∫£o style cho c√°c n√∫t preset t·∫°o ƒë·ªông gi·ªëng n√∫t hyperlink */
        .preset-button {
            display: inline-block;
            padding: 10px 10px;
            font-size: 1em;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            color: #fff;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            margin-right: 10px;
            margin-bottom: 5px; /* Th√™m kho·∫£ng c√°ch n·∫øu nhi·ªÅu n√∫t tr√™n c√πng m·ªôt d√≤ng */
        }
        .preset-button:hover {
            background-color: #0056b3;
        }
        .preset-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }
        .preset-item:last-child {
            border-bottom: none;
        }
        .preset-item button {
            margin-left: 10px;
            padding: 5px 10px;
            font-size: 0.9em;
            background-color: #dc3545; /* Red for delete */
        }
        .preset-item button:hover {
            background-color: #c82333;
        }
        .preset-label {
            flex-grow: 1;
        }

        .topic-management-form {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .message-box {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            display: none; /* Hidden by default */
        }
        .error-message-topic {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .success-message-topic {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        /* CSS cho Collapsible Sections */
        .collapsible-container {
            margin-top: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
            overflow: hidden; /* ƒê·ªÉ ·∫©n n·ªôi dung khi thu g·ªçn */
        }
        .collapsible-header {
            background-color: #e2e6ea;
            color: #333;
            cursor: pointer;
            padding: 15px;
            width: 100%;
            /*text-align: center;*/
            border: none;
            outline: none;
            font-size: 1.1em;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            /* Th√™m thu·ªôc t√≠nh position: relative ƒë·ªÉ m≈©i t√™n c√≥ th·ªÉ ƒë∆∞·ª£c ƒë·ªãnh v·ªã tuy·ªát ƒë·ªëi b√™n trong */
            position: relative; /* TH√äM D√íNG N√ÄY */
        }
        .collapsible-header:hover {
            background-color: #d6dbdf;
        }
        .collapsible-header .arrow {
            font-size: 1.2em;
            transition: transform 0.3s ease;
            /* ƒê·ªäNH V·ªä M≈®I T√äN TUY·ªÜT ƒê·ªêI */
            position: absolute; /* THAY ƒê·ªîI */
            right: 15px; /* ƒê·∫©y sang ph·∫£i v·ªõi kho·∫£ng c√°ch 15px t·ª´ m√©p */
            top: 50%; /* CƒÉn gi·ªØa theo chi·ªÅu d·ªçc */
            transform: translateY(-50%); /* D·ªãch l√™n 50% chi·ªÅu cao c·ªßa ch√≠nh n√≥ ƒë·ªÉ cƒÉn gi·ªØa ch√≠nh x√°c */
        }
        .collapsible-header.active .arrow {
            transform: translateY(-50%) rotate(90deg); /* Gi·ªØ l·∫°i transform Y v√† xoay */
        }
        .collapsible-content {
            padding: 0 18px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out; /* Hi·ªáu ·ª©ng m∆∞·ª£t m√† khi m·ªü/ƒë√≥ng */
        }
        .collapsible-content.show {
            max-height: 400px; /* ƒê·∫∑t m·ªôt chi·ªÅu cao t·ªëi ƒëa c·ª• th·ªÉ, v√≠ d·ª• 400px */
            overflow-y: auto; /* Th√™m thanh cu·ªôn d·ªçc khi n·ªôi dung v∆∞·ª£t qu√° max-height */
            /* ƒê·ªÉ chi·ªÅu cao n√†y ph√π h·ª£p v·ªõi n·ªôi dung c·ªßa b·∫°n. N·∫øu n·ªôi dung qu√° ng·∫Øn, kh√¥ng c√≥ thanh cu·ªôn.
               N·∫øu qu√° d√†i, thanh cu·ªôn s·∫Ω xu·∫•t hi·ªán. */
        }

        /* CSS cho n√∫t hyperlink */
        .hyperlink-button {
            display: inline-block;
            padding: 5px 5px;
            font-size: 1em;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            color: #fff;
            background-color: #007bff; /* M√†u xanh d∆∞∆°ng */
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s ease;
            margin-top: 5px; /* Kho·∫£ng c√°ch v·ªõi c√°c ph·∫ßn t·ª≠ kh√°c */
        }
        .hyperlink-button:hover {
            background-color: #0056b3; /* M√†u xanh ƒë·∫≠m h∆°n khi hover */
        }

        /* Th√™m m·ªôt s·ªë style n·∫øu b·∫°n mu·ªën n√∫t n·∫±m ·ªü m·ªôt v·ªã tr√≠ c·ª• th·ªÉ */
        .admin-button-container {
            text-align: center; /* ƒê·ªÉ cƒÉn gi·ªØa n√∫t n·∫øu mu·ªën */
            margin-bottom: 20px;
        }
        /* CSS cho Dropdown Menu */
        .dropdown {
            position: relative;
            display: inline-block;
            margin-bottom: 5px; /* Th√™m kho·∫£ng c√°ch d∆∞·ªõi menu */
        }
        .dropdown-button {
            background-color: #4CAF50; /* M√†u xanh l√° c√¢y */
            color: white;
            padding: 5px 5px;
            font-size: 1em;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }
        .dropdown-button:hover {
            background-color: #45a049;
        }
        .dropdown-content {
            display: none; /* ·∫®n n·ªôi dung menu theo m·∫∑c ƒë·ªãnh */
            position: absolute;
            background-color: #f9f9f9;
            min-width: 250px; /* Chi·ªÅu r·ªông t·ªëi thi·ªÉu c·ªßa menu */
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 5px;
            padding: 10px;
        }
        .dropdown-content .menu-item {
            color: black; /* ƒê·∫∑t m√†u ch·ªØ cho c√°c m·ª•c menu */
            padding: 5px 10px;
            text-decoration: none;
            display: block;
            border-radius: 3px;
            margin-bottom: 3px; /* Kho·∫£ng c√°ch gi·ªØa c√°c m·ª•c menu */
            background-color: #007bff; /* Gi·ªØ m√†u xanh c·ªßa hyperlink-button */
            color: #fff; /* Ch·ªØ tr·∫Øng */
            text-align: center; /* CƒÉn tr√°i ch·ªØ */
            width: calc(100% - 20px); /* ƒê·∫£m b·∫£o n√∫t chi·∫øm g·∫ßn h·∫øt chi·ªÅu r·ªông */
        }
        .dropdown-content .menu-item:hover {
            background-color: #0056b3; /* ƒê·∫≠m h∆°n khi hover */
        }
        .dropdown:hover .dropdown-content {
            display: block; /* Hi·ªÉn th·ªã menu khi hover v√†o n√∫t dropdown */
        }

        .incorrect-answer {
            font-size: 32px; /* Ho·∫∑c gi√° tr·ªã n√†o ƒë√≥ l·ªõn h∆°n, v√≠ d·ª•: 24px, 32px */
            font-weight: bold;
            color: red; /* Ho·∫∑c m√†u s·∫Øc kh√°c ƒë·ªÉ n·ªïi b·∫≠t l·ªói */
        }
        .option-item {
            border: 1px solid #ccc; /* Vi·ªÅn m·∫∑c ƒë·ªãnh */
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 5px;
            background-color: #f0f0f0; /* N·ªÅn nh·∫π */
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .option-item:hover {
            background-color: #e0e0e0;
            border-color: #999;
        }
        /* Style cho khi ch·ªçn ƒë√°p √°n */
        .option-item.selected {
            background-color: #d1ecf1; /* N·ªÅn xanh nh·∫°t khi ƒë∆∞·ª£c ch·ªçn */
            border-color: #bee5eb;
        }
        /* Style cho ƒë√°p √°n ƒë√∫ng (c√≥ th·ªÉ d√πng sau khi tr·∫£ l·ªùi) */
        .option-item.correct {
            background-color: #d4edda; /* N·ªÅn xanh l√° c√¢y nh·∫°t */
            border-color: #28a745;
        }
        /* Style cho ƒë√°p √°n sai (c√≥ th·ªÉ d√πng sau khi tr·∫£ l·ªùi) */
        .option-item.incorrect {
            background-color: #f8d7da; /* N·ªÅn ƒë·ªè nh·∫°t */
            border-color: #dc3545;
        }

        .select-all-topics {
            margin-bottom: 10px; /* Kho·∫£ng c√°ch d∆∞·ªõi cho checkbox "Ch·ªçn to√†n b·ªô" */
        }
    </style>
</head>
<body>
    <div style="display: flex; align-items: baseline;">
        <h1 style="margin-bottom: 5px;">B√¢y gi·ªù l√†: <span id="realtimeClock"></span>, <span id="currentDate"></span>. </h1>
        <div id="countdown" style="color: burlywood; margin-left: 10px;">Th·ªùi gian c√≤n l·∫°i: <span id="time"></span> <span id="question-progress"></span></div>
    </div>

    <div class="dropdown">
        <button class="dropdown-button">ADM</button>
        <div class="dropdown-content">
            <button id="view-leaderboard">Xem B·∫£ng X·∫øp H·∫°ng</button>
            <button id="clear-leaderboard">X√≥a B·∫£ng X·∫øp H·∫°ng</button>
            <a href="http://127.0.0.1:5000/admin" target="_blank" class="hyperlink-button"> Truy c·∫≠p Trang Admin </a>
        </div>
    </div>

    <a href="http://127.0.0.1:5000/" class="hyperlink-button">http://127.0.0.1:5000/</a>
    <button id="preset-70A-5B-5C-5D" class="hyperlink-button">Doituong2</button>
    <button id="Doituong1" class="hyperlink-button">Doituong1</button>

    <div class="collapsible-container">
        <button type="button" class="collapsible-header" id="quiz-settings-header">
            Khung n·ªôi dung ch√≠nh <span class="arrow">&#9658;</span>
        </button>

        <div class="collapsible-content show" id="quiz-settings-content">
            <form id="quiz-settings">
                <label for="duration">Th·ªùi gian l√†m b√†i (ph√∫t):</label>
                <input type="number" id="duration" name="duration" value="50" min="1">
                <label for="num_questions">T·ªïng s·ªë l∆∞·ª£ng c√¢u h·ªèi t·ªëi ƒëa cho ph√©p:</label>
                <input type="number" id="num_questions" name="num_questions" value="300" min="1"><br>
                <div style="margin-top: 15px;">
                    <label for="all_topics_question_count">S·ªë c√¢u h·ªèi cho t·∫•t c·∫£ ch·ªß ƒë·ªÅ:</label>
                    <input type="number" id="all_topics_question_count" value="20" min="0">
                    <button type="button" id="apply_to_all_topics">√Åp d·ª•ng cho t·∫•t c·∫£</button>
                </div>

                <div class="collapsible-container">
                    <button type="button" class="collapsible-header" id="topic-selection-header">
                        Ch·ªçn Ch·ªß ƒë·ªÅ chuy√™n m√¥n nghi·ªáp v·ª• ƒë·ªÉ √¥n luy·ªán <span class="arrow">‚ñ∫</span>
                    </button>
                    <div class="collapsible-content" id="topic-selection-content"> 
                        <div id="topic-inputs-container">
                        </div>
                    </div>
                </div>
                <p>T·ªïng s·ªë c√¢u h·ªèi ƒë√£ ch·ªçn: <span id="total-topic-questions">0</span>...</p>
                <p id="form-error-message" class="error-message"></p>
                <button type="submit">B·∫Øt ƒë·∫ßu b√†i thi</button>
            </form>
        </div>
    </div>

    <div id="quiz-container" style="display: none;">
        <div id="question"></div>
        <ul id="options"></ul>
        <button id="submit-answer">Ti·∫øp theo</button>
        <button id="submit-final">N·ªôp b√†i</button>
        <div id="answer-feedback" class="answer-feedback" style="display: none;"></div>
    </div>


    <div id="result-container" style="display: none;">
        <h2>K·∫øt qu·∫£</h2>
        <p id="score"></p>
        <button id="restart-quiz">L√†m l·∫°i</button>
    </div>

    <div id="leaderboard-container" style="display: none;">
        <h2>B·∫£ng X·∫øp H·∫°ng</h2>
        <table id="leaderboard">
            <thead>
                <tr>
                    <th>T√™n</th>
                    <th>ƒêi·ªÉm</th>
                    <th>Th·ªùi gian ho√†n th√†nh</th>
                </tr>
            </thead>
            <tbody id="leaderboard-body"></tbody>
        </table>
    </div>

    <div class="preset-buttons-container">
        <footer>
            <p>&copy; [Phi√™n b·∫£n: 20250519.0.6 | Li√™n h·ªá: <a href="mailto:lequocvan19@gmail.com">vanlequoc</a>] C√πng s·ª± tr·ª£ gi√∫p c·ªßa Google Gemini, L√™ Qu·ªëc V√¢n Cooker ch·∫≠p ch·ªØng bi·∫øn √Ω t∆∞·ªüng d·ª±ng website local √¥n t·∫≠p tr·∫Øc nghi·ªám b·∫±ng l·∫≠p tr√¨nh Python, pytz, Flask, flask_bcrypt, flask_login, db-sqlite3, pandas, openpyXL; <br> T·ª´ t·∫≠p tin questions.xlsx v·ªõi 02 sheets Questions (id c√¢u h·ªèi ƒë√°p √°n ƒë√∫ng); Options (id c√¢u h·ªèi c√°c ƒë√°p √°n l·ª±a ch·ªçn) t·∫°o ra *.db cho ph√©p l·ª±a ch·ªçn s·ªë l∆∞·ª£ng c√¢u h·ªèi theo t·ª´ng ch·ªß ƒë·ªÅ, ng·∫´u nhi√™n c√¢u h·ªèi theo ch·ªß ƒë·ªÅ v√† ƒë·∫£o ng·∫´u nhi√™n ƒë√°p √°n l·ª±a ch·ªçn c·ªßa t·ª´ng c√¢u h·ªèi. Tham kh·∫£o: <a href="https://github.com/lequocvan/python_quiz_TracNghiem">Github; </a><a href="https://youtu.be/I8p13W6vsYQ?si=PPCl4vw5AloTTpjj">Youtube</a></p>
        </footer>
    </div>

    <div id="update-topic-container">
        <label for="old_topic_name">T√™n Ch·ªß ƒë·ªÅ C≈®:</label>
        <input type="text" id="old_topic_name" placeholder="Nh·∫≠p t√™n ch·ªß ƒë·ªÅ c≈©">
        <label for="new_topic_name">T√™n Ch·ªß ƒë·ªÅ M·ªöI:</label>
        <input type="text" id="new_topic_name" placeholder="Nh·∫≠p t√™n ch·ªß ƒë·ªÅ m·ªõi">
        <button id="update_topic_button">C·∫≠p nh·∫≠t Ch·ªß ƒë·ªÅ (th·∫≠n tr·ªçng nh√©)</button>
        <div id="update-topic-message"></div>
    </div>

    <script>
        const currentDateElement = document.getElementById('currentDate');
        const now = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        currentDateElement.textContent = now.toLocaleDateString('vi-VN', options);

        const realtimeClockElement = document.getElementById('realtimeClock');
        function updateRealtimeClock() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            realtimeClockElement.textContent = `${hours}:${minutes}:${seconds}`;
        }
        // C·∫≠p nh·∫≠t ƒë·ªìng h·ªì ngay l·∫≠p t·ª©c khi t·∫£i trang
        updateRealtimeClock();
        // C·∫≠p nh·∫≠t ƒë·ªìng h·ªì m·ªói gi√¢y
        setInterval(updateRealtimeClock, 1000);

        const countdownElement = document.getElementById('countdown');
        const timeDisplay = document.getElementById('time');
        const quizSettingsForm = document.getElementById('quiz-settings');
        const quizContainer = document.getElementById('quiz-container');
        const questionElement = document.getElementById('question');
        const optionsElement = document.getElementById('options');
        const submitAnswerButton = document.getElementById('submit-answer');
        const submitFinalButton = document.getElementById('submit-final'); // L·∫•y tham chi·∫øu n√∫t N·ªôp b√†i
        const answerFeedbackElement = document.getElementById('answer-feedback');
        const resultContainer = document.getElementById('result-container');
        const scoreElement = document.getElementById('score');
        const restartQuizButton = document.getElementById('restart-quiz');
        const durationInput = document.getElementById('duration'); // L·∫•y input th·ªùi gian

        const topicInputsContainer = document.getElementById('topic-inputs-container');
        const totalTopicQuestionsElement = document.getElementById('total-topic-questions');
        const numQuestionsInput = document.getElementById('num_questions');
        const formErrorMessage = document.getElementById('form-error-message');

        const leaderboardContainer = document.getElementById('leaderboard-container');
        const leaderboardTableBody = document.getElementById('leaderboard-body');
        const viewLeaderboardButton = document.getElementById('view-leaderboard');
        const clearLeaderboardButton = document.getElementById('clear-leaderboard'); // L·∫•y tham chi·∫øu n√∫t x√≥a
        let leaderboardData = loadLeaderboard(); // T·∫£i d·ªØ li·ªáu b·∫£ng x·∫øp h·∫°ng khi trang t·∫£i
        // ƒê·∫£m b·∫£o n√∫t "Xem B·∫£ng X·∫øp H·∫°ng" lu√¥n hi·ªÉn th·ªã
        if (viewLeaderboardButton) {
            viewLeaderboardButton.style.display = 'inline-block'; // Ho·∫∑c 'block'
        }

        let currentQuestionIndex = 0;
        let allQuestionsData = []; // L∆∞u tr·ªØ to√†n b·ªô d·ªØ li·ªáu c√¢u h·ªèi
        let questionsData = []; // L∆∞u tr·ªØ c√°c c√¢u h·ªèi s·∫Ω hi·ªÉn th·ªã (c√≥ th·ªÉ l√† ng·∫´u nhi√™n)
        let selectedAnswers = [];
        let timerInterval;
        let timeLeft;
        let correctAnswersCount = 0; // Bi·∫øn ƒë·∫øm s·ªë c√¢u tr·∫£ l·ªùi ƒë√∫ng
        let hasAnswered = false; // Theo d√µi xem ng∆∞·ªùi d√πng ƒë√£ tr·∫£ l·ªùi c√¢u h·ªèi hi·ªán t·∫°i ch∆∞a
        let questionTimeout; // Bi·∫øn ƒë·ªÉ l∆∞u ID c·ªßa setTimeout cho m·ªói c√¢u h·ªèi

        let questionStartTime; // Th√™m bi·∫øn ƒë·ªÉ l∆∞u th·ªùi gian b·∫Øt ƒë·∫ßu m·ªôt c√¢u h·ªèi
        let questionDetailsList = []; // Th√™m m·∫£ng ƒë·ªÉ l∆∞u chi ti·∫øt t·ª´ng c√¢u h·ªèi

        const questionProgressElement = document.getElementById('question-progress');

        // JavaScript cho Collapsible Sections
        const quizSettingsHeader = document.getElementById('quiz-settings-header');
        const quizSettingsContent = document.getElementById('quiz-settings-content');

        quizSettingsHeader.addEventListener('click', () => {
            quizSettingsHeader.classList.toggle('active');
            if (quizSettingsContent.classList.contains('show')) {
                quizSettingsContent.classList.remove('show');
                quizSettingsContent.style.maxHeight = null;
            } else {
                quizSettingsContent.classList.add('show');
                quizSettingsContent.style.maxHeight = quizSettingsContent.scrollHeight + "px";
            }
        });


        // New elements for applying to all topics
        const allTopicsQuestionCountInput = document.getElementById('all_topics_question_count');
        const applyToAllTopicsButton = document.getElementById('apply_to_all_topics');

        if (applyToAllTopicsButton) {
            applyToAllTopicsButton.addEventListener('click', () => {
                const count = parseInt(allTopicsQuestionCountInput.value, 10);
                if (isNaN(count) || count < 0) {
                    alert("Vui l√≤ng nh·∫≠p m·ªôt s·ªë h·ª£p l·ªá cho s·ªë c√¢u h·ªèi.");
                    return;
                }

                const topicInputs = document.querySelectorAll('#topic-inputs-container input[type="number"]');
                const topicCheckboxes = document.querySelectorAll('#topic-inputs-container input[type="checkbox"]');

                topicInputs.forEach((input, index) => {
                    const checkbox = topicCheckboxes[index];
                    if (checkbox.checked) {
                        input.value = count;
                    }
                });
                updateTopicQuestionCount();
                enforceTotalLimit();
            });
        }

        // Th√™m x·ª≠ l√Ω cho ph·∫ßn collapsible Ch·ªß ƒë·ªÅ m·ªõi
        const topicSelectionHeader = document.getElementById('topic-selection-header');
        const topicSelectionContent = document.getElementById('topic-selection-content');

        topicSelectionHeader.addEventListener('click', () => {
            topicSelectionHeader.classList.toggle('active');
            if (topicSelectionContent.classList.contains('show')) {
                topicSelectionContent.classList.remove('show');
                topicSelectionContent.style.maxHeight = null;
            } else {
                topicSelectionContent.classList.add('show');
                topicSelectionContent.style.maxHeight = topicSelectionContent.scrollHeight + "px";
            }
        });

        // ƒê·∫£m b·∫£o collapsible ch√≠nh ƒë∆∞·ª£c m·ªü khi t·∫£i trang ho·∫∑c thi·∫øt l·∫≠p l·∫°i n·∫øu c·∫ßn
        // N·∫øu b·∫°n mu·ªën m·∫∑c ƒë·ªãnh ph·∫ßn "Ch·ªçn Ch·ªß ƒë·ªÅ" m·ªü khi t·∫£i trang, th√™m class 'show' v√†o div
        // topic-selection-content v√† ƒëo·∫°n m√£ sau.
        // Ng∆∞·ª£c l·∫°i, n·∫øu mu·ªën m·∫∑c ƒë·ªãnh ƒë√≥ng, b·ªè qua ƒëo·∫°n m√£ d∆∞·ªõi.
        if (quizSettingsContent.classList.contains('show')) {
             quizSettingsContent.style.maxHeight = quizSettingsContent.scrollHeight + "px";
        }
        // N·∫øu b·∫°n mu·ªën ph·∫ßn ch·ªçn ch·ªß ƒë·ªÅ m·ªü m·∫∑c ƒë·ªãnh
        if (topicSelectionContent.classList.contains('show')) {
             topicSelectionContent.style.maxHeight = topicSelectionContent.scrollHeight + "px";
             topicSelectionHeader.classList.add('active'); // ƒê·∫£m b·∫£o m≈©i t√™n xoay ƒë√∫ng h∆∞·ªõng
        }


        // H√†m x√°o tr·ªôn m·∫£ng (Thu·∫≠t to√°n Fisher-Yates)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function updateTopicQuestionCount() {
            let total = 0;
            const topicInputs = document.querySelectorAll('#topic-inputs-container input[type="number"]');
            topicInputs.forEach(input => {
                total += parseInt(input.value) || 0;
            });
            totalTopicQuestionsElement.textContent = total;
            return total;
        }


        
        // L·∫•y danh s√°ch ch·ªß ƒë·ªÅ topic khi trang t·∫£i
        fetch('/get_topics')
            .then(response => response.json())
            .then(topics => {
                topics.forEach(topic => {
                    const topicInputGroup = document.createElement('div');
                    topicInputGroup.className = 'topic-input-group';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = topic;
                    checkbox.name = topic;

                    const label = document.createElement('label');
                    label.textContent = topic;
                    label.setAttribute('for', topic);


                    const input = document.createElement('input');
                    input.type = 'number';
                    input.value = 0;
                    input.min = 0;
                    input.max = 100;
                    input.disabled = true; // Disable initially

                    checkbox.addEventListener('change', () => {
                        input.disabled = !checkbox.checked;
                        if (!checkbox.checked) {
                            input.value = 0; // Reset value when unchecked
                        }
                        updateTopicQuestionCount();
                        enforceTotalLimit();
                    });

                    input.addEventListener('change', () => {
                        updateTopicQuestionCount();
                        enforceTotalLimit();
                    });

                    topicInputGroup.appendChild(checkbox);
                    topicInputGroup.appendChild(label);
                    topicInputGroup.appendChild(input);
                    topicInputsContainer.appendChild(topicInputGroup);
                });
                updateTopicQuestionCount();
            });

        function enforceTotalLimit() {
            const numQuestions = parseInt(numQuestionsInput.value, 10);
            const topicInputs = document.querySelectorAll('#topic-inputs-container input[type="number"]');
            let currentTotal = updateTopicQuestionCount();

            topicInputs.forEach(input => {
                if (!input.disabled) {
                    let selectedValue = parseInt(input.value, 10) || 0;
                    // The max value for an individual topic input should be the total allowed
                    // minus the sum of other selected topics.
                    // This logic might be complex if you want to strictly prevent exceeding the total.
                    // A simpler approach is to check the total on submit and show an error.
                    // For now, let's just make sure individual inputs don't exceed the overall num_questions.
                    input.max = numQuestions; // Can set a higher max here, and validate on submit
                } else {
                    input.max = numQuestions;
                }
            });
        }

        // H√†m m·ªõi ƒë·ªÉ l·∫•y v√† hi·ªÉn th·ªã t·∫•t c·∫£ c√°c preset_name
        function loadAndDisplayPresets() {
            const dynamicPresetButtonsContainer = document.getElementById('dynamic-preset-buttons');
            dynamicPresetButtonsContainer.innerHTML = ''; // X√≥a c√°c n√∫t c≈© n·∫øu c√≥

            fetch('/get_all_preset_names')
                .then(response => response.json())
                .then(presetNames => {
                    if (presetNames.length === 0) {
                        dynamicPresetButtonsContainer.textContent = "Kh√¥ng t√¨m th·∫•y c·∫•u h√¨nh preset n√†o.";
                        return;
                    }

                    presetNames.forEach(presetName => {
                        const button = document.createElement('button');
                        button.textContent = presetName;
                        button.className = 'preset-button'; // S·ª≠ d·ª•ng class CSS m·ªõi
                        button.addEventListener('click', () => {
                            // G·ªçi endpoint ph√π h·ª£p d·ª±a tr√™n presetName
                            let configEndpoint = '';
                            if (presetName === 'Doituong1') {
                                configEndpoint = '/get_Doituong1_config';
                            } else if (presetName === 'Doituong2') {
                                configEndpoint = '/get_preset_70a_5b_5c_5d_config';
                            }
                            // Th√™m c√°c tr∆∞·ªùng h·ª£p kh√°c cho c√°c preset_name kh√°c n·∫øu c·∫ßn
                            // else if (presetName === 'Ten_Preset_Khac') {
                            //     configEndpoint = '/get_Ten_Preset_Khac_config';
                            // }
                            
                            if (configEndpoint) {
                                fetch(configEndpoint)
                                    .then(response => {
                                        if (!response.ok) {
                                            throw new Error('Network response was not ok ' + response.statusText);
                                        }
                                        return response.json();
                                    })
                                    .then(presetCounts => {
                                        setPresetTopicCounts(presetCounts);
                                        formErrorMessage.textContent = `ƒê√£ t·∫£i c·∫•u h√¨nh cho preset: ${presetName}`;
                                        formErrorMessage.className = 'success-message';
                                        formErrorMessage.style.display = 'block';
                                    })
                                    .catch(error => {
                                        console.error(`L·ªói khi l·∫•y c·∫•u h√¨nh preset "${presetName}":`, error);
                                        formErrorMessage.textContent = `Kh√¥ng th·ªÉ t·∫£i c·∫•u h√¨nh cho preset "${presetName}". Vui l√≤ng th·ª≠ l·∫°i.`;
                                        formErrorMessage.className = 'error-message';
                                        formErrorMessage.style.display = 'block';
                                    });
                            } else {
                                formErrorMessage.textContent = `Ch∆∞a c√≥ c·∫•u h√¨nh endpoint cho preset: ${presetName}.`;
                                formErrorMessage.className = 'error-message';
                                formErrorMessage.style.display = 'block';
                            }
                        });
                        dynamicPresetButtonsContainer.appendChild(button);
                    });
                })
                .catch(error => {
                    console.error("L·ªói khi t·∫£i danh s√°ch preset:", error);
                    dynamicPresetButtonsContainer.textContent = "Kh√¥ng th·ªÉ t·∫£i danh s√°ch preset. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi.";
                });
        }
        
        // X·ª≠ l√Ω preset 70A-5B-5C-5D Doituong2
        document.getElementById('preset-70A-5B-5C-5D').addEventListener('click', () => {
            fetch('/get_preset_70a_5b_5c_5d_config')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    return response.json();
                })
                .then(presetCounts => {
                    setPresetTopicCounts(presetCounts);
                })
                .catch(error => {
                    console.error("L·ªói khi l·∫•y c·∫•u h√¨nh preset:", error);
                    formErrorMessage.textContent = "Kh√¥ng th·ªÉ t·∫£i c·∫•u h√¨nh preset. Vui l√≤ng th·ª≠ l·∫°i.";
                });
        });

        // X·ª≠ l√Ω preset Doituong1
        document.getElementById('Doituong1').addEventListener('click', () => {
            fetch('/get_Doituong1_config')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    return response.json();
                })
                .then(presetCounts => {
                    setPresetTopicCounts(presetCounts);
                })
                .catch(error => {
                    console.error("L·ªói khi l·∫•y c·∫•u h√¨nh preset:", error);
                    formErrorMessage.textContent = "Kh√¥ng th·ªÉ t·∫£i c·∫•u h√¨nh preset. Vui l√≤ng th·ª≠ l·∫°i.";
                });
        });


        function setPresetTopicCounts(presetCounts) {
            const topicInputs = document.querySelectorAll('#topic-inputs-container input[type="number"]');
            const topicCheckboxes = document.querySelectorAll('#topic-inputs-container input[type="checkbox"]');

            // ƒê·∫∑t t·∫•t c·∫£ v·ªÅ 0 v√† b·ªè ch·ªçn
            topicInputs.forEach(input => {
                input.value = 0;
                input.disabled = true;
            });
            topicCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });

            // √Åp d·ª•ng c√°c gi√° tr·ªã preset
            for (const topicName in presetCounts) {
                const checkbox = document.getElementById(topicName);
                if (checkbox) {
                    checkbox.checked = true;
                    // Find the input element associated with this checkbox
                    const input = checkbox.parentNode.querySelector('input[type="number"]');
                    if (input) {
                        input.value = presetCounts[topicName];
                        input.disabled = false;
                    }
                }
            }
            updateTopicQuestionCount(); // C·∫≠p nh·∫≠t t·ªïng s·ªë c√¢u h·ªèi ƒë√£ ch·ªçn
            enforceTotalLimit(); // ƒê·∫£m b·∫£o gi·ªõi h·∫°n t·ªïng s·ªë c√¢u h·ªèi
        }


        
        quizSettingsForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const numQuestions = parseInt(document.getElementById('num_questions').value);
            const durationMinutes = parseInt(durationInput.value);
            const totalTopicQuestions = updateTopicQuestionCount();

            formErrorMessage.textContent = '';

            // The backend will handle fetching questions to meet numQuestions,
            // so we don't need to block if totalTopicQuestions < numQuestions here.
            // But if totalTopicQuestions > numQuestions, it's an error.
            if (totalTopicQuestions > numQuestions) {
                formErrorMessage.textContent = `T·ªïng s·ªë c√¢u h·ªèi theo ch·ªß ƒë·ªÅ (${totalTopicQuestions}) v∆∞·ª£t qu√° T·ªïng s·ªë l∆∞·ª£ng c√¢u h·ªèi t·ªëi ƒëa cho ph√©p (${numQuestions}).`;
                return;
            }

            timeLeft = durationMinutes * 60;
            correctAnswersCount = 0;
            currentQuestionIndex = 0;
            selectedAnswers = new Array(numQuestions).fill(null);
            questionDetailsList = []; // Reset question details list
            hasAnswered = false;

            const topicCounts = {};
            const topicInputs = document.querySelectorAll('#topic-inputs-container input[type="number"]');
            const topicCheckboxes = document.querySelectorAll('#topic-inputs-container input[type="checkbox"]');

            topicInputs.forEach((input, index) => {
                // Ensure the checkbox is checked AND the input value is greater than 0
                if (topicCheckboxes[index].checked && parseInt(input.value) > 0) {
                    const topicName = topicCheckboxes[index].id;
                    topicCounts[topicName] = parseInt(input.value);
                }
            });
            
            fetch('/start_quiz', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    num_questions: numQuestions,
                    duration: durationMinutes,
                    topics: topicCounts
                })
            })
            .then(response => {
                if (!response.ok) {
                    // Check if the response is JSON before parsing
                    return response.json().then(errorData => {
                        throw new Error(errorData.error || 'Unknown error from server');
                    });
                }
                return response.json();
            })
            .then(data => {
                // Check if the data is an error object
                if (data.error) {
                    formErrorMessage.textContent = `Error: ${data.error}`;
                    return;
                }
                allQuestionsData = data;
                const shuffledQuestions = shuffleArray([...allQuestionsData]);
                questionsData = shuffledQuestions.slice(0, numQuestions); // Ensure we only take 'numQuestions'

                if (questionsData.length === 0) {
                    formErrorMessage.textContent = "Kh√¥ng c√≥ c√¢u h·ªèi n√†o ƒë∆∞·ª£c t√¨m th·∫•y v·ªõi c√°c ch·ªß ƒë·ªÅ ƒë√£ ch·ªçn. Vui l√≤ng ch·ªçn l·∫°i.";
                    return;
                }

                quizSettingsForm.style.display = 'none';
                quizContainer.style.display = 'block';
                startTimer();
                showQuestion();
            })
            .catch(error => {
                console.error("L·ªói khi g·ª≠i d·ªØ li·ªáu:", error);
                formErrorMessage.textContent = "C√≥ l·ªói x·∫£y ra khi b·∫Øt ƒë·∫ßu b√†i thi: " + error.message;
            });
        });

        function startTimer() {
            clearInterval(timerInterval); // X√≥a interval c≈© n·∫øu c√≥
            timerInterval = setInterval(updateTimer, 1000);
        }

        function updateTimer() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = (timeLeft % 60).toString().padStart(2, '0');
            timeDisplay.textContent = `${minutes}:${seconds}`;
            timeLeft--;

            if (timeLeft < 0) {
                clearInterval(timerInterval);
                alert("H·∫øt th·ªùi gian l√†m b√†i!");
                submitQuiz(); // T·ª± ƒë·ªông n·ªôp b√†i khi h·∫øt th·ªùi gian
            }
        }

        function showQuestion() {
            answerFeedbackElement.style.display = 'none'; // ·∫®n ph·∫£n h·ªìi ƒë√°p √°n khi hi·ªÉn th·ªã c√¢u h·ªèi m·ªõi
            hasAnswered = false; // Reset tr·∫°ng th√°i ƒë√£ tr·∫£ l·ªùi cho c√¢u h·ªèi m·ªõi
            clearTimeout(questionTimeout); // H·ªßy b·ªè timeout c·ªßa c√¢u h·ªèi tr∆∞·ªõc n·∫øu c√≥

            if (currentQuestionIndex < questionsData.length) {
                const currentQuestion = questionsData[currentQuestionIndex];
                questionElement.textContent = `${currentQuestionIndex + 1}. ${currentQuestion.question_text}`;
                optionsElement.innerHTML = '';

                questionProgressElement.textContent = `(${currentQuestionIndex + 1}/${questionsData.length})`;
                questionStartTime = Date.now(); // Ghi l·∫°i th·ªùi gian b·∫Øt ƒë·∫ßu c√¢u h·ªèi

                // T√°ch chu·ªói options th√†nh m·∫£ng
                const options = currentQuestion.options ? currentQuestion.options.split('|||') : [];
                const shuffledOptions = shuffleArray(options);

                shuffledOptions.forEach((option, index) => {
                    const li = document.createElement('li');
                    li.className = 'option-item'; // Th√™m l·ªõp CSS m·ªõi v√†o li
                    li.innerHTML = `
                        <input type="radio" name="answer" value="${option}" id="option-${index}">
                        <label for="option-${index}">${option}</label>
                    `;
                    const input = li.querySelector('input');

                    input.addEventListener('change', () => {
                        // X√≥a l·ªõp 'selected' kh·ªèi t·∫•t c·∫£ c√°c m·ª•c kh√°c
                        document.querySelectorAll('.option-item').forEach(item => {
                            item.classList.remove('selected');
                        });
                        // Th√™m l·ªõp 'selected' v√†o m·ª•c hi·ªán t·∫°i khi ƒë∆∞·ª£c ch·ªçn
                        li.classList.add('selected');

                        selectedAnswers[currentQuestionIndex] = option;
                        hasAnswered = true; // Mark as answered when an option is selected
                        clearTimeout(questionTimeout); // Stop timeout if user answers manually
                    });

                    optionsElement.appendChild(li);

                    if (selectedAnswers[currentQuestionIndex] === option) {
                        input.checked = true;
                        li.classList.add('selected'); // ƒê·∫£m b·∫£o m·ª•c ƒë∆∞·ª£c ch·ªçn c√≥ l·ªõp 'selected' khi t·∫£i l·∫°i
                    }
                });

                // Display "N·ªôp b√†i" button always, "Ti·∫øp theo" only if not last question
                submitFinalButton.style.display = 'inline-block';
                if (currentQuestionIndex === questionsData.length - 1) {
                    submitAnswerButton.style.display = 'none'; // Hide "Ti·∫øp theo" on the last question
                } else {
                    submitAnswerButton.style.display = 'inline-block';
                }

                // H·∫πn gi·ªù t·ª± ƒë·ªông hi·ªÉn th·ªã ƒë√°p √°n v√† chuy·ªÉn c√¢u sau 30 gi√¢y
                questionTimeout = setTimeout(() => {
                    showCorrectAnswerAndNext();
                }, 30000); // 30000 milliseconds = 30 gi√¢y

            } else {
                // If there are no more questions to show, submit the quiz
                clearInterval(timerInterval);
                submitQuiz();
            }
        }

        submitAnswerButton.addEventListener('click', () => {
            clearTimeout(questionTimeout); // H·ªßy b·ªè timeout khi ng∆∞·ªùi d√πng b·∫•m "Ti·∫øp theo"
            const selectedOption = document.querySelector('input[name="answer"]:checked');

            const currentQuestion = questionsData[currentQuestionIndex];
            const timeSpent = Math.round((Date.now() - questionStartTime) / 1000); // Th·ªùi gian l√†m c√¢u h·ªèi

            let userAnswer = null;
            let isCorrect = 0; // 0 for false, 1 for true

            if (selectedOption) {
                userAnswer = selectedOption.value;
                if (userAnswer === currentQuestion.correct_answer) {
                    isCorrect = 1;
                }
                showAnswerFeedback(userAnswer);
            } else {
                // User didn't select an answer, treat as unanswered
                showAnswerFeedback(null); // Pass null to indicate no selection
            }

            questionDetailsList.push({
                question_id: currentQuestion.id,
                question_text: currentQuestion.question_text,
                user_answer: userAnswer,
                correct_answer: currentQuestion.correct_answer,
                is_correct: isCorrect,
                time_spent_on_question: timeSpent
            });

            setTimeout(() => {
                currentQuestionIndex++;
                showQuestion();
            }, 5000); // Wait 5 seconds before moving to the next question
        });

        // H√†m hi·ªÉn th·ªã ph·∫£n h·ªìi ƒë√°p √°n
        function showAnswerFeedback(selectedValue) {
            const currentQuestion = questionsData[currentQuestionIndex];
            const correctAnswer = currentQuestion.correct_answer;

            answerFeedbackElement.style.display = 'block';

            // G·ª° b·ªè c√°c l·ªõp m√†u c≈© v√† th√™m l·ªõp m√†u m·ªõi cho t·∫•t c·∫£ c√°c t√πy ch·ªçn
            document.querySelectorAll('.option-item').forEach(item => {
                item.classList.remove('correct', 'incorrect', 'selected'); // X√≥a c√°c l·ªõp m√†u c≈© v√† l·ªõp selected
            });

            // Highlight ƒë√°p √°n ƒë√∫ng
            document.querySelectorAll('#options input[name="answer"]').forEach(input => {
                const li = input.closest('li');
                if (input.value === correctAnswer) {
                    li.classList.add('correct');
                } else if (selectedValue !== null && input.value === selectedValue) { // N·∫øu l√† ƒë√°p √°n ng∆∞·ªùi d√πng ch·ªçn v√† l√† sai
                    li.classList.add('incorrect');
                }
            });

            if (selectedValue === correctAnswer) {
                answerFeedbackElement.textContent = "Ch√≠nh x√°c! üéâ Ch√∫c m·ª´ng!"; 
                answerFeedbackElement.className = "answer-feedback correct-answer";
                // correctAnswersCount is incremented when saving to questionDetailsList for consistency
            } else if (selectedValue === null) {
                answerFeedbackElement.textContent = `H·∫øt th·ªùi gian. ƒê√°p √°n ƒë√∫ng l√†: ${correctAnswer}`;
                answerFeedbackElement.className = "answer-feedback incorrect-answer"; // Use incorrect-answer for timeout too
            } else {
                answerFeedbackElement.textContent = `SAI. ƒê√°p √°n ƒë√∫ng l√†: ${correctAnswer}`;
                answerFeedbackElement.className = "answer-feedback incorrect-answer";
            }
        }

        function showCorrectAnswerAndNext() {
            const currentQuestion = questionsData[currentQuestionIndex];
            const correctAnswer = currentQuestion.correct_answer;

            const timeSpent = Math.round((Date.now() - questionStartTime) / 1000); // Th·ªùi gian l√†m c√¢u h·ªèi

            // Record that user didn't answer (user_answer will be null)
            questionDetailsList.push({
                question_id: currentQuestion.id,
                question_text: currentQuestion.question_text,
                user_answer: null, // No answer selected
                correct_answer: correctAnswer,
                is_correct: 0, // Not correct
                time_spent_on_question: timeSpent
            });

            answerFeedbackElement.textContent = `ƒê√£ h·∫øt th·ªùi gian. ƒê√°p √°n ƒë√∫ng l√†: ${correctAnswer}`;
            answerFeedbackElement.className = "answer-feedback auto-next";
            answerFeedbackElement.style.display = 'block';

            // G·ª° b·ªè c√°c l·ªõp m√†u c≈© v√† th√™m l·ªõp m√†u m·ªõi cho t·∫•t c·∫£ c√°c t√πy ch·ªçn
            document.querySelectorAll('.option-item').forEach(item => {
                item.classList.remove('correct', 'incorrect', 'selected'); // X√≥a c√°c l·ªõp m√†u c≈©
            });

            // Highlight ƒë√°p √°n ƒë√∫ng khi t·ª± ƒë·ªông chuy·ªÉn
            document.querySelectorAll('#options input[name="answer"]').forEach(input => {
                const li = input.closest('li');
                if (input.value === correctAnswer) {
                    li.classList.add('correct');
                }
            });

            // Add text-to-speech for correct answer
            if ('speechSynthesis' in window) {
                const speech = new SpeechSynthesisUtterance();
                speech.lang = 'vi-VN';
                speech.text = `ƒê√°p √°n ƒë√∫ng l√†: ${correctAnswer}`;
                window.speechSynthesis.speak(speech);
            }

            setTimeout(() => {
                currentQuestionIndex++;
                showQuestion();
            }, 10000); // Chuy·ªÉn sang c√¢u ti·∫øp theo sau 10 gi√¢y
        }

        // X·ª≠ l√Ω s·ª± ki·ªán click n√∫t "N·ªôp b√†i"
        submitFinalButton.addEventListener('click', () => {
            clearTimeout(questionTimeout); // D·ª´ng b·ªô h·∫πn gi·ªù 36 gi√¢y ƒë·∫øm cho c√¢u h·ªèi hi·ªán t·∫°i (n·∫øu n√≥ ƒëang ch·∫°y)
            clearInterval(timerInterval); // D·ª´ng b·ªô ƒë·∫øm th·ªùi gian T·ªïng c·ªßa b√†i thi
            
            // Record current question's state if it hasn't been recorded yet
            if (currentQuestionIndex < questionsData.length) {
                const currentQuestion = questionsData[currentQuestionIndex];
                const selectedOption = document.querySelector('input[name="answer"]:checked');
                const timeSpent = Math.round((Date.now() - questionStartTime) / 1000);

                let userAnswer = null;
                let isCorrect = 0;
                if (selectedOption) {
                    userAnswer = selectedOption.value;
                    if (userAnswer === currentQuestion.correct_answer) {
                        isCorrect = 1;
                    }
                }
                
                questionDetailsList.push({
                    question_id: currentQuestion.id,
                    question_text: currentQuestion.question_text,
                    user_answer: userAnswer,
                    correct_answer: currentQuestion.correct_answer,
                    is_correct: isCorrect,
                    time_spent_on_question: timeSpent
                });
            }

            submitQuiz();
        });


        function saveScore(score, totalQuestions, percentage, timeTaken) {
            const playerName = prompt("Nh·∫≠p t√™n c·ªßa b·∫°n ƒë·ªÉ l∆∞u ƒëi·ªÉm:");
            if (playerName) {
                fetch('/save_quiz_result', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        player_name: playerName,
                        score: score,
                        total_questions: totalQuestions,
                        percentage: percentage,
                        time_taken: timeTaken,
                        question_details: questionDetailsList // G·ª≠i chi ti·∫øt c√¢u h·ªèi
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert("L·ªói khi l∆∞u ƒëi·ªÉm: " + data.error);
                    } else {
                        alert("ƒêi·ªÉm c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng!");
                        // Optionally update local leaderboard data as well if it's still being used for display
                        // This part might need adjustment if you rely solely on the database for leaderboard
                        leaderboardData.push({ name: playerName, score: score, time: timeTaken });
                        leaderboardData.sort((a, b) => b.score - a.score);
                        saveLeaderboard(); // Save to localStorage for local leaderboard display
                    }
                })
                .catch(error => {
                    console.error("L·ªói khi g·ª≠i d·ªØ li·ªáu l∆∞u ƒëi·ªÉm:", error);
                    alert("C√≥ l·ªói x·∫£y ra khi l∆∞u ƒëi·ªÉm.");
                });
            }
        }

        function saveLeaderboard() {
            localStorage.setItem('quizLeaderboard', JSON.stringify(leaderboardData));
        }

        function loadLeaderboard() {
            const storedLeaderboard = localStorage.getItem('quizLeaderboard');
            return storedLeaderboard ? JSON.parse(storedLeaderboard) : [];
        }

        function displayLeaderboard() {
            console.log('D·ªØ li·ªáu b·∫£ng x·∫øp h·∫°ng:', leaderboardData);
            leaderboardTableBody.innerHTML = ''; // X√≥a d·ªØ li·ªáu c≈©
            leaderboardData.forEach(entry => {
                const row = leaderboardTableBody.insertRow();
                const nameCell = row.insertCell();
                const scoreCell = row.insertCell();
                const timeCell = row.insertCell();
                nameCell.textContent = entry.name;
                scoreCell.textContent = entry.score;
                const minutes = Math.floor(entry.time / 60);
                const seconds = (entry.time % 60).toString().padStart(2, '0');
                timeCell.textContent = `${minutes}:${seconds}`;
            });
            quizSettingsForm.style.display = 'none';
            quizContainer.style.display = 'none';
            resultContainer.style.display = 'none';
            leaderboardContainer.style.display = 'block';
        }

        function clearLeaderboard() {
            if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô b·∫£ng x·∫øp h·∫°ng?")) {
                localStorage.removeItem('quizLeaderboard');
                leaderboardData = [];
                displayLeaderboard(); // C·∫≠p nh·∫≠t l·∫°i hi·ªÉn th·ªã b·∫£ng x·∫øp h·∫°ng
            }
        }


        function submitQuiz() {
            clearInterval(timerInterval); // D·ª´ng ƒë·ªìng h·ªì khi n·ªôp b√†i
            clearTimeout(questionTimeout); // ƒê·∫£m b·∫£o h·ªßy timeout khi n·ªôp b√†i
            
            // Calculate final score based on questionDetailsList
            correctAnswersCount = questionDetailsList.filter(detail => detail.is_correct === 1).length;

            questionProgressElement.textContent = ''; // Ho·∫∑c c√≥ th·ªÉ ·∫©n n√≥

            quizContainer.style.display = 'none';
            resultContainer.style.display = 'block';
            // T√≠nh to√°n t·ª∑ l·ªá ph·∫ßn trƒÉm
            const percentage = (correctAnswersCount / questionsData.length) * 100;

            scoreElement.textContent = `B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng ${correctAnswersCount} tr√™n ${questionsData.length} c√¢u h·ªèi (${percentage.toFixed(2)}%).`;
            
            // Save score after displaying results
            // The time taken is (initial duration in seconds) - (timeLeft at submission)
            const timeTaken = (parseInt(durationInput.value) * 60) - timeLeft;
            saveScore(correctAnswersCount, questionsData.length, percentage, timeTaken);
        }


        restartQuizButton.addEventListener('click', () => {
            resultContainer.style.display = 'none';
            quizSettingsForm.style.display = 'block';
            clearInterval(timerInterval); // D·ª´ng ƒë·ªìng h·ªì khi l√†m l·∫°i
            clearTimeout(questionTimeout); // H·ªßy b·ªè timeout khi l√†m l·∫°i
            timeDisplay.textContent = ''; // X√≥a th·ªùi gian hi·ªÉn th·ªã
            currentQuestionIndex = 0;
            selectedAnswers = [];
            questionsData = [];
            questionDetailsList = []; // Reset question details list
            correctAnswersCount = 0; // Reset ƒëi·ªÉm s·ªë khi l√†m l·∫°i
            submitAnswerButton.style.display = 'inline-block'; // Hi·ªÉn th·ªã l·∫°i n√∫t "Ti·∫øp theo"
            submitFinalButton.style.display = 'none'; // ·∫®n n√∫t "N·ªôp b√†i"
            hasAnswered = false;
            formErrorMessage.textContent = ''; // Clear any previous error messages
        });


        // Th√™m s·ª± ki·ªán l·∫Øng nghe cho n√∫t xem b·∫£ng x·∫øp h·∫°ng
        viewLeaderboardButton.addEventListener('click', displayLeaderboard);

        // Th√™m s·ª± ki·ªán l·∫Øng nghe cho n√∫t x√≥a b·∫£ng x·∫øp h·∫°ng
        clearLeaderboardButton.addEventListener('click', clearLeaderboard);

        // ·∫®n n√∫t "N·ªôp b√†i" ban ƒë·∫ßu
        submitFinalButton.style.display = 'none';
        
        // Initial call to update total question count and enforce limits
        updateTopicQuestionCount();
        enforceTotalLimit();



        // Th√™m JavaScript cho ch·ª©c nƒÉng c·∫≠p nh·∫≠t topic
        const updateTopicButton = document.getElementById('update_topic_button');
        const oldTopicNameInput = document.getElementById('old_topic_name');
        const newTopicNameInput = document.getElementById('new_topic_name');
        const updateTopicMessage = document.getElementById('update-topic-message');

        updateTopicButton.addEventListener('click', () => {
            const oldTopic = oldTopicNameInput.value.trim();
            const newTopic = newTopicNameInput.value.trim();

            updateTopicMessage.style.display = 'none'; // ·∫®n th√¥ng b√°o c≈©
            updateTopicMessage.className = ''; // X√≥a l·ªõp CSS c≈©

            if (!oldTopic || !newTopic) {
                updateTopicMessage.textContent = "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t√™n ch·ªß ƒë·ªÅ c≈© v√† m·ªõi.";
                updateTopicMessage.className = 'error-message-topic';
                updateTopicMessage.style.display = 'block';
                return;
            }

            fetch('/update_topic', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    old_topic: oldTopic,
                    new_topic: newTopic
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    updateTopicMessage.textContent = `L·ªói: ${data.error}`;
                    updateTopicMessage.className = 'error-message-topic';
                } else {
                    updateTopicMessage.textContent = `Topic ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng! (Questions: ${data.questions_updated}, Presets: ${data.presets_updated})`;
                    updateTopicMessage.className = 'success-message';
                    // X√≥a gi√° tr·ªã trong input sau khi th√†nh c√¥ng
                    oldTopicNameInput.value = '';
                    newTopicNameInput.value = '';

                    // C·∫≠p nh·∫≠t l·∫°i danh s√°ch ch·ªß ƒë·ªÅ n·∫øu b·∫°n mu·ªën hi·ªÉn th·ªã n√≥ trong form quiz ngay l·∫≠p t·ª©c
                    // ƒêi·ªÅu n√†y y√™u c·∫ßu g·ªçi l·∫°i h√†m fetch('/get_topics') v√† x√¢y d·ª±ng l·∫°i c√°c checkbox/input
                    // Ho·∫∑c ƒë∆°n gi·∫£n h∆°n l√† nh·∫Øc ng∆∞·ªùi d√πng l√†m m·ªõi trang.
                    alert("Topic ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng. Vui l√≤ng l√†m m·ªõi trang ƒë·ªÉ xem c√°c thay ƒë·ªïi trong danh s√°ch ch·ªß ƒë·ªÅ.");
                }
                updateTopicMessage.style.display = 'block';
            })
            .catch(error => {
                console.error("L·ªói khi c·∫≠p nh·∫≠t topic:", error);
                updateTopicMessage.textContent = "C√≥ l·ªói x·∫£y ra khi g·ª≠i y√™u c·∫ßu c·∫≠p nh·∫≠t topic.";
                updateTopicMessage.className = 'error-message-topic';
                updateTopicMessage.style.display = 'block';
            });
        });
    </script>
</body>
</html>